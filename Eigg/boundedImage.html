
<!DOCTYPE html>
<html lang="en">
<head>
    <title>Satellite Imagery in OpenLayers - Azure Maps Web SDK Samples</title>

    <meta charset="utf-8" />
    <meta http-equiv="x-ua-compatible" content="IE=Edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="This sample shows how to render Azure Maps Satellite/Aerial imagery tiles in the OpenLayers map control." />
    <meta name="keywords" content="Microsoft maps, map, gis, API, SDK, raster, imagery, satellite, aerial, tiles, Open Layers, OpenLayers" />
    <meta name="author" content="Microsoft Azure Maps" />

    <!-- Add references to the Azure Maps Map control JavaScript and CSS files. -->
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css" />
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.1.0/papaparse.js"></script>
</head>
<body>
    <input id="fileInput" type="file"/>
    <div id="myMap" style="margin:0;padding:0"></div>
    <script type='text/javascript'>
        //Add your Azure Maps subscription key to the map SDK. Get an Azure Maps key at https://azure.com/maps
        var subscriptionKey = 'tTk1JVEaeNvDkxxnxHm9cYaCvqlOq1u-fXTvyXn2XkA';

        var map;

        function initialiseMapObj(){
            map = new ol.Map({
                target: 'myMap',
                layers: [
                    new ol.layer.Tile({
                        source: new ol.source.XYZ({
                            url: 'https://atlas.microsoft.com/map/imagery/png?api-version=1&style=satellite&tileSize=256&view=Auto&zoom={z}&x={x}&y={y}' +
                                '&subscription-key=' + subscriptionKey,
                            attributions: `Â© ${new Date().getFullYear()} DigitalGlobe, Microsoft`,
                            tileSize: 256
                        })
                    })
                ],
                view: new ol.View({
                    center: [0, 0],
                    zoom: 13
                })
            });

            map.getView().setCenter(ol.proj.transform([-6.1960333,56.907887], 'EPSG:4326', 'EPSG:3857'));
            map.getView().setZoom(13);

            return map;
        }

        function transformLatLonToMapObj(kz){
            return kz.map(coords => {
                const [ln, lat] = coords.split(",");
                return new ol.Feature({
                        geometry: new ol.geom.Point(ol.proj.transform([parseFloat(lat), parseFloat(ln)], 'EPSG:4326',     
                        'EPSG:3857')),
                    });
            });
        }

        function createMapLayer(kz, icon, scaled, textIn){
            var points = transformLatLonToMapObj(kz)

            const pinLayer = new ol.layer.Vector ({
            source: new ol.source.Vector ({
                    features: [...points]
                }),
                style: new ol.style.Style ({
                    image: new ol.style.Icon({
                        src: icon,
                        scale: scaled
                    }),
                    text: new ol.style.Text({
                        text: textIn,
                        scale: 1.0,
                        offsetY : -20,
                        fill: new ol.style.Fill({
                            color: "#fff"
                        }),
                        stroke: new ol.style.Stroke({
                            color: "0",
                            width: 3
                        })
                    })
                })
            });
            return pinLayer
        }

        function addLineToMap(pointsIncoming){
            const points = pointsIncoming.map(x => x.reverse()).map(x => ol.proj.transform(x, 'EPSG:4326', 'EPSG:3857'))

            var featureLine = new ol.Feature({
                geometry: new ol.geom.LineString(points)
            });

            var vectorLine = new ol.source.Vector({});
            vectorLine.addFeature(featureLine);

            var vectorLineLayer = new ol.layer.Vector({
                source: vectorLine,
                style: new ol.style.Style({
                    fill: new ol.style.Fill({ color: '#00FF00', weight: 4 }),
                    stroke: new ol.style.Stroke({ color: '#00FF00', width: 2 })
                })
            });

            return vectorLineLayer
        }

        function getDefaultConfigVals(){
            return {marker: './fullColMarkers/marker76.png'}
        }

        const getBaseLog = (x, y) => Math.log(y) / Math.log(x)
        const scalePoint = (point) => 0.005*getBaseLog(8,point) 

        function processData(incomingText) {
            var map = initialiseMapObj()
            var text = JSON.parse(incomingText)
            var allText = text["result"]

            var element = document.getElementById("fileInput");
            element.parentNode.removeChild(element);

            allText.forEach(dataObject => {
                const coordsToPlot = dataObject["plots"]["locs"]
                const connections = dataObject["plots"]["linkMatrix"]

                var configs = (dataObject["configs"] === undefined) ? getDefaultConfigVals() : dataObject["configs"]

                connections.forEach(x => {
                    map.addLayer(addLineToMap(x))
                })

                // Adding data point icons
                coordsToPlot.forEach((x,k) => {
                    map.addLayer(createMapLayer([x["location"]], configs["marker"], x["size"],x["desc"]))
                })

            });
        }
        
        document.getElementById('fileInput').addEventListener('change', function selectedFileChanged() {
            const reader = new FileReader();
            Papa.parse(this.files[0], {
                complete: function(results) {
                    processData(results.data)
                }
            });
        });
    </script>
</body>
</html>